[gd_scene load_steps=9 format=3 uid="uid://byfiroliiyvqy"]

[ext_resource type="Theme" uid="uid://dilir1ustsxj1" path="res://themes/panel_container_theme.tres" id="1_kdfef"]
[ext_resource type="StyleBox" uid="uid://ck44vm33io7h3" path="res://themes/info_panel_style.tres" id="1_y35qy"]
[ext_resource type="FontFile" uid="uid://cm3updcfcy5k4" path="res://fonts/Bitcount_Single/BitcountSingle-VariableFont_CRSV,ELSH,ELXP,slnt,wght.ttf" id="2_qe2ex"]
[ext_resource type="Theme" uid="uid://bbg4rpfu1k53c" path="res://themes/push_button_theme.tres" id="3_amoat"]

[sub_resource type="GDScript" id="GDScript_hke2t"]
resource_name = "main"
script/source = "extends Control

const WATCH_RETRY_INTERVAL = 2.0
const WAIT_INTERVAL = 0.25
const FILENAME = \"user://camera_capabilities.json\"

var status_string : String = \"\":
	set(new_string):
		status_string = new_string
		var label : Label = get_node_or_null(\"%StatusLabel\")
		if label:
			%StatusLabel.text = \"Status: %s\" % [new_string]

func _ready():
	print(\"hullo debug\")
	status_string = \"Aide-De-Cam plugin not detected\"
	_watch_for_plugin()
	
func _watch_for_plugin():
	if AideDeCam.is_plugin_available():
		AideDeCam.capabilities_updated.connect(_display_capabilties_from_file)
		status_string = \"Connected to singleton\"
		return
		
	status_string = \"Aide-De-Cam plugin not detected\"	
	await get_tree().create_timer(WATCH_RETRY_INTERVAL).timeout
	_watch_for_plugin()
	
func _display_capabilties_from_file():
	await get_tree().create_timer(WAIT_INTERVAL).timeout
	status_string = \"displaying json\"
	var return_dic : Dictionary = _parse_capabilities_json()
	if return_dic.is_empty():
		status_string = \"Error: empty file!?\"
		return
	
	var _nl : Label = get_node_or_null(\"%RigNameLabel\")
	var _il : Label = get_node_or_null(\"%RigInfoLabel\")
	var _gc : GridContainer = get_node_or_null(\"%GridContainer\")
	
	if _nl == null or _il == null or _gc == null:
		status_string = \"Error: UI sections missing\"
		return
	
	%RigNameLabel.text = \"Rig: \" + return_dic.line_device
	%RigInfoLabel.text = \"Info: \" + return_dic.line_system
	var camera_count = return_dic.camera_lines.size()
	%GridContainer.columns = _calc_grid_columns(camera_count)
	
	var existing_panels : Array[Node] = %GridContainer.get_children()

	if existing_panels.size() > camera_count:
		for i : int in range(existing_panels.size(), camera_count, -1):
			existing_panels[i-1].queue_free()
			existing_panels.pop_back()
	
	elif existing_panels.size() < camera_count:
		for i : int in range(existing_panels.size(), camera_count):
			_create_and_add_grid_panel()
		existing_panels = %GridContainer.get_children()
	
	status_string = \"Camera lines # %d\" % [return_dic.camera_lines.size()]
	_populate_camera_panels(return_dic.camera_lines, existing_panels)

	status_string = \"Info queried %s\" % [Time.get_datetime_string_from_unix_time(int(return_dic.timestamp / 1000.0), true)]

func _populate_camera_panels(cam_lines : Array, panels : Array[Node]):
	for idx : int in range(0, cam_lines.size()):
		panels[idx].get_child(0).get_child(0).text = cam_lines[idx]
		status_string = \"populating: %d\" % [idx]

func _calc_grid_columns(item_count : int) -> int:
	var result : int = ceili(sqrt(item_count))
	return result

func _create_and_add_grid_panel():
	var pan : Panel = Panel.new()
	pan.theme = preload(\"res://themes/cam_panel_theme.tres\")
	pan.size_flags_horizontal = Control.SIZE_EXPAND_FILL
	pan.size_flags_vertical = Control.SIZE_EXPAND_FILL
	
	var mc : MarginContainer = MarginContainer.new()
	mc.set_anchors_preset(Control.PRESET_FULL_RECT)
	pan.add_child(mc)
	mc.owner = pan
	
	var lab : Label = Label.new()
	lab.set_anchors_preset(Control.PRESET_FULL_RECT)
	lab.vertical_alignment = VERTICAL_ALIGNMENT_TOP
	lab.autowrap_mode = TextServer.AUTOWRAP_WORD_SMART
	#lab.clip_text = true
	mc.add_child(lab)
	lab.owner = mc
	%GridContainer.add_child(pan)
	pan.owner = %GridContainer

func _parse_capabilities_json() -> Dictionary:
	var text := FileAccess.get_file_as_string(FILENAME)
	if text.is_empty():
		push_error(\"Empty file: %s\" % FILENAME)
		return {}

	var parsed : Variant = JSON.parse_string(text)
	if parsed == null or typeof(parsed) != TYPE_DICTIONARY:
		push_error(\"Invalid JSON in: %s\" % FILENAME)
		return {}

	var root: Dictionary = parsed

	# 1) Manufacturer, model, android version
	var manufacturer := str(root.get(\"device_manufacturer\", \"unknown\"))
	var model := str(root.get(\"device_model\", \"unknown\"))
	var android_version := str(root.get(\"android_version\", \"unknown\"))
	var line_device := \"%s %s (Android %s)\" % [manufacturer, model, android_version]

	# 2) SDK, permissions, concurrency info
	var sdk := int(root.get(\"sdk_version\", -1))
	var perm := bool(root.get(\"camera_permission_granted\", false))

	var cc: Dictionary = root.get(\"concurrent_camera_support\", {})
	var cc_supported := bool(cc.get(\"supported\", false))
	var max_cc := int(cc.get(\"max_concurrent_cameras\", 0))
	var combos: Array = cc.get(\"camera_id_combinations\", [])

	var combos_str := \"\"
	if cc_supported:
		# combos is an array of arrays of strings, e.g. [[\"0\",\"1\"],[\"0\",\"3\"]]
		var combo_parts: Array[String] = []
		for combo in combos:
			if typeof(combo) == TYPE_ARRAY:
				combo_parts.append(\"[\" + \",\".join(combo) + \"]\")
		combos_str = \", combos=\" + \"; \".join(combo_parts)
	else:
		combos_str = \"\"

	var line_system := \"SDK %d | camera_permission=%s | concurrent=%s (max=%d)%s\" % [
		sdk, str(perm), str(cc_supported), max_cc, combos_str
	]

	# 3) Timestamp (of query)
	var timestamp := int(root.get(\"timestamp\"))

	# 4) One string per camera: include individual properties EXCEPT fps_ranges and output_formats
	var camera_lines: Array[String] = []
	var cameras: Array = root.get(\"cameras\", [])
	for camv in cameras:
		if typeof(camv) != TYPE_DICTIONARY:
			continue
		var cam: Dictionary = camv

		var cam_id := str(cam.get(\"camera_id\", \"unknown\"))
		var facing := str(cam.get(\"facing\", \"unknown\"))
		var hw := str(cam.get(\"hardware_level\", \"unknown\"))
		var logical := bool(cam.get(\"is_logical_multi_camera\", false))

		var sensor: Dictionary = cam.get(\"sensor\", {})
		var pa_w :Variant = sensor.get(\"pixel_array_width\", null)
		var pa_h :Variant = sensor.get(\"pixel_array_height\", null)
		var phys_w :Variant = sensor.get(\"physical_width_mm\", null)
		var phys_h :Variant = sensor.get(\"physical_height_mm\", null)
		var iso_min :Variant = sensor.get(\"iso_min\", null)
		var iso_max :Variant = sensor.get(\"iso_max\", null)

		var focal_lengths: Array = cam.get(\"focal_lengths\", [])
		var apertures: Array = cam.get(\"apertures\", [])

		var warnings: Array = cam.get(\"warnings\", [])

		var parts: Array[String] = []
		#parts.append(\"id=%s\" % cam_id)
		parts.append(\"facing=%s\" % facing)
		parts.append(\"hw=%s\" % hw)
		parts.append(\"logical=%s\" % str(logical))


		if pa_w != null and pa_h != null:
			parts.append(\"pixel_array=%sx%s\" % [str(pa_w), str(pa_h)])
		if phys_w != null and phys_h != null:
			parts.append(\"sensor_mm=%sx%s\" % [str(phys_w), str(phys_h)])
		if iso_min != null and iso_max != null:
			parts.append(\"iso=%s-%s\" % [str(iso_min), str(iso_max)])

		if focal_lengths.size() > 0:
			parts.append(\"focal_lengths=%s\" % [\", \".join(focal_lengths)])
		if apertures.size() > 0:
			parts.append(\"apertures=%s\" % [\", \".join(apertures)])

		if warnings.size() > 0:
			parts.append(\"warnings=%s\" % [\"; \".join(warnings)])

		camera_lines.append(\"Camera id=%s\\n\\n\" % cam_id + \" | \".join(parts))

	return {
		\"line_device\": line_device,
		\"line_system\": line_system,
		\"camera_lines\": camera_lines,
		\"timestamp\": timestamp
	}


func _process(_delta):
	#print(\"still running\")
	pass
"

[sub_resource type="GDScript" id="GDScript_xry8p"]
resource_name = "query_button"
script/source = "extends TouchButt

var status_string : String =\"\":
	set(new_string):
		status_string = new_string
		var label : Label = get_node_or_null(\"%StatusLabel\")
		if label:
			%StatusLabel.text = new_string

func _ready():
	self.pressed.connect(_on_button_pressed)
	
func _on_button_pressed():
	if not AideDeCam.is_plugin_available():
		status_string = \"Error: no AideDeCam\"
		return

	status_string = str(Engine.has_singleton(\"AideDeCam\"))
	#AideDeCam.get_camera_capabilities_to_file(\"demmmmm\")#.repeat(100))
	AideDeCam.get_camera_capabilities()
	status_string = \"Capabilities requested\"
"

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_8beu7"]
content_margin_left = 15.0
content_margin_top = 15.0
content_margin_right = 15.0
content_margin_bottom = 15.0
bg_color = Color(0.662928, 0.360109, 0, 1)
border_width_left = 4
border_width_top = 4
border_width_right = 4
border_width_bottom = 4
border_color = Color(1, 1, 1, 1)
border_blend = true
corner_radius_top_left = 16
corner_radius_top_right = 16
corner_radius_bottom_right = 16
corner_radius_bottom_left = 16

[sub_resource type="GDScript" id="GDScript_o8cm5"]
resource_name = "exit_button"
script/source = "extends TouchButt

const EXIT_DELAY = 1.0

func _ready():
	self.pressed.connect(_on_button_pressed)
	
func _on_button_pressed():
	await get_tree().create_timer(EXIT_DELAY).timeout
	get_tree().quit()
"

[node name="Main" type="Control"]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
script = SubResource("GDScript_hke2t")

[node name="MarginContainer" type="MarginContainer" parent="."]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
theme_override_constants/margin_left = 75
theme_override_constants/margin_top = 75
theme_override_constants/margin_right = 75
theme_override_constants/margin_bottom = 40

[node name="VBoxContainer" type="VBoxContainer" parent="MarginContainer"]
layout_mode = 2
theme_override_constants/separation = 20

[node name="HeaderContainer" type="HBoxContainer" parent="MarginContainer/VBoxContainer"]
layout_mode = 2

[node name="RigNamePanel" type="PanelContainer" parent="MarginContainer/VBoxContainer/HeaderContainer"]
layout_mode = 2
size_flags_horizontal = 3
size_flags_stretch_ratio = 5.0
theme = ExtResource("1_kdfef")

[node name="MarginContainer" type="MarginContainer" parent="MarginContainer/VBoxContainer/HeaderContainer/RigNamePanel"]
layout_mode = 2
theme_override_constants/margin_left = 15
theme_override_constants/margin_top = 5
theme_override_constants/margin_right = 15
theme_override_constants/margin_bottom = 5

[node name="RigNameLabel" type="Label" parent="MarginContainer/VBoxContainer/HeaderContainer/RigNamePanel/MarginContainer"]
unique_name_in_owner = true
layout_mode = 2
theme_override_fonts/font = ExtResource("2_qe2ex")
theme_override_font_sizes/font_size = 35
text = "<Rig Name>"
vertical_alignment = 1

[node name="QueryButton" type="Button" parent="MarginContainer/VBoxContainer/HeaderContainer"]
layout_mode = 2
size_flags_horizontal = 10
size_flags_vertical = 0
focus_mode = 0
theme = ExtResource("3_amoat")
text = "Query"
script = SubResource("GDScript_xry8p")

[node name="BoxContainer" type="BoxContainer" parent="MarginContainer/VBoxContainer/HeaderContainer"]
custom_minimum_size = Vector2(100, 1.45519e-11)
layout_mode = 2

[node name="RigInfoPanel" type="PanelContainer" parent="MarginContainer/VBoxContainer"]
layout_mode = 2

[node name="MarginContainer" type="MarginContainer" parent="MarginContainer/VBoxContainer/RigInfoPanel"]
layout_mode = 2
theme_override_constants/margin_left = 10
theme_override_constants/margin_top = 5
theme_override_constants/margin_right = 10
theme_override_constants/margin_bottom = 5

[node name="RigInfoLabel" type="Label" parent="MarginContainer/VBoxContainer/RigInfoPanel/MarginContainer"]
unique_name_in_owner = true
layout_mode = 2
theme_override_fonts/font = ExtResource("2_qe2ex")
theme_override_font_sizes/font_size = 30
text = "<Rig Info>"

[node name="GridMargin" type="MarginContainer" parent="MarginContainer/VBoxContainer"]
layout_mode = 2
size_flags_vertical = 3
size_flags_stretch_ratio = 20.0
theme_override_constants/margin_left = 50
theme_override_constants/margin_right = 50
theme_override_constants/margin_bottom = -35

[node name="GridContainer" type="GridContainer" parent="MarginContainer/VBoxContainer/GridMargin"]
unique_name_in_owner = true
layout_mode = 2
size_flags_vertical = 3
theme_override_constants/h_separation = 35
theme_override_constants/v_separation = 20
columns = 3

[node name="HBoxContainer" type="HBoxContainer" parent="MarginContainer/VBoxContainer"]
layout_mode = 2
size_flags_vertical = 8

[node name="StatusPanel" type="PanelContainer" parent="MarginContainer/VBoxContainer/HBoxContainer"]
custom_minimum_size = Vector2(1.45519e-11, 35)
layout_mode = 2
size_flags_horizontal = 3
size_flags_vertical = 10
size_flags_stretch_ratio = 5.0
theme_override_styles/panel = ExtResource("1_y35qy")

[node name="MarginContainer" type="MarginContainer" parent="MarginContainer/VBoxContainer/HBoxContainer/StatusPanel"]
layout_mode = 2
theme_override_constants/margin_left = 15
theme_override_constants/margin_top = 5
theme_override_constants/margin_right = 15
theme_override_constants/margin_bottom = 5

[node name="StatusLabel" type="Label" parent="MarginContainer/VBoxContainer/HBoxContainer/StatusPanel/MarginContainer"]
unique_name_in_owner = true
layout_mode = 2
theme_override_fonts/font = ExtResource("2_qe2ex")
theme_override_font_sizes/font_size = 30
text = "Status: [undefined]"
vertical_alignment = 1

[node name="ExitButton" type="Button" parent="MarginContainer/VBoxContainer/HBoxContainer"]
layout_mode = 2
size_flags_horizontal = 10
focus_mode = 0
theme = ExtResource("3_amoat")
theme_override_styles/hover = SubResource("StyleBoxFlat_8beu7")
theme_override_styles/normal = SubResource("StyleBoxFlat_8beu7")
text = "Exit"
script = SubResource("GDScript_o8cm5")

[node name="BoxContainer" type="BoxContainer" parent="MarginContainer/VBoxContainer/HBoxContainer"]
custom_minimum_size = Vector2(100, 1.45519e-11)
layout_mode = 2
